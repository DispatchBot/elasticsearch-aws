{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Create the auto-scaling group for running Elasticsearch",

  "Parameters": {
    "Vpc": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "The VPC to place all resources into"
    },

    "PrivateSubnet1": { "Type": "AWS::EC2::Subnet::Id" },
    "PrivateSubnet2": { "Type": "AWS::EC2::Subnet::Id" },
    "PrivateSubnet3": { "Type": "AWS::EC2::Subnet::Id" },

   "ELBSecurityPolicyName": {
     "Type": "String",
     "Description": "Name of the SSL/Cipher policy to use for the ELB SSL",
     "Default": "ELBSecurityPolicy-TLS-1-2-2017-01"
   },

    "EcsInstanceType" : {
      "Type" : "String",
      "Description" : "ECS EC2 instance type",
      "Default" : "t2.micro",
      "AllowedValues" : [
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m5.large",
        "m5.xlarge",
        "m5.2xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge"
      ],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    },

    "MinClusterSize": {
      "Type": "Number",
      "Description": "Minimum number of active nodes in the cluster.",
      "Default": 3
    },

    "MaxClusterSize": {
      "Type": "Number",
      "Description": "Maximum number of active nodes in the cluster.",
      "Default": 10
    },

    "DesiredClusterSize": {
      "Type": "Number",
      "Description": "The desired number of nodes to have in the cluster. Acts as a default number.",
      "Default": 5
    },

    "EC2KeyName": {
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Description": "The key name to give to the allocated EC2s",
      "Default": ""
    },

    "PrivateFQDomain": {
      "Type": "String",
      "Description": "The Private Fully Qualified Domain Name you will use for this cluster. This will be created in Route53"
    },

    "PrivateHostedZone": {
      "Type": "AWS::Route53::HostedZone::Id",
      "Description": "The Private Route53 zone you are placing these resources into"
    },

    "VolumeSize": {
      "Type": "Number",
      "Description": "Size of EBS data volume in GB"
    },

    "Certificate": {
      "Type": "String",
      "Description": "The ARN of the SSL cert to use with the ELB"
    },

    "ElbS3LoggingBucket": {
      "Type": "String",
      "Description": "The name of the S3 bucket to push ELB logs to"
    },

    "Tenancy": {
      "Type": "String",
      "Description": "The allowed tenancy of instances launched",
      "Default": "default",
      "AllowedValues": [ "default", "dedicated" ]
    }
  },

  "Mappings" : {
    "AMI": {
      "us-west-2": { "Value": "ami-0aa51c6b209594418" },
      "us-east-2": { "Value": "ami-066c85f9c48e28947" }
    },
    "Ec2Endpoint": {
      "us-west-2": { "Value": "ec2.us-west-2.amazonaws.com" },
      "us-east-2": { "Value": "ec2.us-east-2.amazonaws.com" }
    }
  },

  "Resources": {
    "S3RepositoryBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "AccessControl": "Private"
      }
    },

    "AccessElasticsearchSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "A group of resources that can access Elasticsesarch",
        "VpcId" : { "Ref" : "Vpc" }
      }
    },

    "PrivateElbSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Ports that internal resources can access on our ELB",
        "VpcId" : { "Ref" : "Vpc" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "tcp", "FromPort" : 9200, "ToPort" : 9200,
            "SourceSecurityGroupId" : { "Ref": "AccessElasticsearchSecurityGroup" } },
          { "IpProtocol" : "tcp", "FromPort" : 9200, "ToPort" : 9200,
            "SourceSecurityGroupId" : { "Ref": "ElasticSearchSecurityGroup" } }
        ]
      }
    },

    "EcsSecurityGroup" : {
     "Type" : "AWS::EC2::SecurityGroup",
     "Properties" : {
       "GroupDescription" : "Ports that our ELB can access of our ECS cluster.",
       "VpcId" : { "Ref" : "Vpc" },
       "SecurityGroupIngress" : [
         {
           "IpProtocol" : "tcp",
           "FromPort" : 9200,
           "ToPort" : 9200,
           "SourceSecurityGroupId" :  { "Ref" : "PrivateElbSecurityGroup" }
         }
       ]
      }
    },

    "EcsCluster": {
      "Type" : "AWS::ECS::Cluster"
    },

    "ElasticSearchSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Group for ES to perform self discovery within.",
        "VpcId" : { "Ref" : "Vpc" },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 9300,
            "ToPort": 9300,
            "CidrIp": "10.0.0.0/16"
          }
        ]
      }
    },

    "PrivateElb": {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "AccessLoggingPolicy": {
          "EmitInterval": 60,
          "Enabled": true,
          "S3BucketName": { "Ref": "ElbS3LoggingBucket" },
          "S3BucketPrefix": { "Fn::Join": ["/", [ { "Ref": "AWS::StackName" }, "elb"]] }
        },
        "SecurityGroups" : [ { "Ref" : "PrivateElbSecurityGroup" }, { "Ref" : "AccessElasticsearchSecurityGroup" } ],
        "Subnets" : [{ "Ref" : "PrivateSubnet1" }, { "Ref" : "PrivateSubnet2" }, { "Ref" : "PrivateSubnet3" }],
        "CrossZone" : "true",
        "LoadBalancerName": { "Ref": "AWS::StackName" },
        "Scheme": "internal",
        "HealthCheck": {
          "Interval": "15",
          "Target": "HTTPS:9200/",
          "Timeout": "5",
          "UnhealthyThreshold": "2",
          "HealthyThreshold": "2"
        },
        "Listeners" : [ {
          "Protocol": "HTTPS",
          "InstanceProtocol": "HTTPS",
          "LoadBalancerPort" : 9200,
          "InstancePort" : 9200,
          "SSLCertificateId": { "Ref": "Certificate"},
          "PolicyNames": [ { "Ref": "ELBSecurityPolicyName" } ]
        }],
        "Policies": [
          {
            "PolicyName": "ELBSSLSecurityPolicy",
            "PolicyType": "SSLNegotiationPolicyType",
            "Attributes": [
              {
                "Name": "Reference-Security-Policy",
                "Value": { "Ref": "ELBSecurityPolicyName" }
              }
            ]
          },
          {
            "PolicyName": "MyPublicKeyPolicy",
            "PolicyType": "PublicKeyPolicyType",
            "Attributes": [
              {
                "Name": "PublicKey",
                "Value": {
                  "Fn::Join": [
                    "\n",
                    [
                      "MIIFFTCCAv4CCQCronx+M1PkszANBgkqhkiG9w0BAQsFADBOMQswCQYDVQQGEwJY",
                      "WDENMAsGA1UECAwEWFhYWDENMAsGA1UEBwwEWFhYWDENMAsGA1UECgwEWFhYWDES",
                      "MBAGA1UEAwwJbG9jYWxob3N0MB4XDTE5MTIxMjE3MDEzOFoXDTI5MTIwOTE3MDEz",
                      "OFowTjELMAkGA1UEBhMCWFgxDTALBgNVBAgMBFhYWFgxDTALBgNVBAcMBFhYWFgx",
                      "DTALBgNVBAoMBFhYWFgxEjAQBgNVBAMMCWxvY2FsaG9zdDCCAiAwDQYJKoZIhvcN",
                      "AQEBBQADggINADCCAggCggH/JpLCDGMS48KzVvITWgG+TRwA/nVNhXgKBQ5gapwp",
                      "qTnK54/XqDBr4slFRhOaxqCyLgtHrH6qCRkvLt8HQjE6vuzVjKdKGey8wA5qwVM+",
                      "btGqYhCaYl+huhaEc/wPZH+Myq1A6xHdJEl1dKkzGzcP0CgbA80+ueo2Nv0fWv+Q",
                      "J07LToQEKNv3Tlw8paSzVG+d09JMr9p6AeHk9kJM52Qx/fyOsQwUKSVgo/+OS0rr",
                      "mU7Ovjhp+BQn16qNFqubKvyk6YavAfwwtDblVh2NtXGwpR1bcW8Xj6IO7Zeo3HXh",
                      "9H7ELdBL5MarYzFwECIld3BQGC9kgRbwQdz8WPN5IDM3iowDtLc1GXP8zC+qBEgj",
                      "m5HW58d+iFdFUjgdvNc1PHLeCa0uUetjtbzkGrWI2dFcXcN8lPsbcDYWIO3u2CdA",
                      "COYrVKDGORPuuc2/+jkqrKFwDQeOzkuZRhuFbgo9toWu8sOVQuZwrE0f43SWRaIC",
                      "tv8032efN8XYC5ehUGzJPIiV8wkbxXqi+BsgowoDrsnNhHfvGpJyQ8wZgWqKoGI5",
                      "1ay6ZZQfmPuxP4ZmP2dq1ziPG9RGVqWixu2F45khJIxQc2/WmnI6E5XLXlQ+eBU1",
                      "HFDqo6AJ74kkLuY7JbVG7GcWg5adAdBpk3NTAj1DpBy71OE2X290iZPUovFdpJhT",
                      "qQIDAQABMA0GCSqGSIb3DQEBCwUAA4ICAAAJXD9uzBOlcE/p1eP1FfBY325fF8NM",
                      "chODW1vRbowMZd3I4c+iup9LakwPcm5gIKTPWuHJsgSX8dzKin1S6ZUpUYgRwMIF",
                      "JgdS6Fom7L+ibjhdzVzxNzsTjVxDjeUP3XALVm3RNyPKtrL2LJMw4gqZOqi6goGb",
                      "r0Hk2yfI/BTXDldxi/+Kyv4b9p2G7nkEtejX9hC6mn0TXN+Tmhbri4aPuyVDotR3",
                      "4MH5XlhoAckW8PpzgFA+RyBkAth6SQ4vKEtcOYNMNcwGzRjm0WdybVlU174tm3bn",
                      "ZvbBqKJ6YaO//mF8ibBxhOMa8ST6EUypIwXMcJrTs6i93Ih2o7v61yYen0keQiht",
                      "sJR2n8wU/zNr0B13fO3nzl52Y2aU/rhnektIueIVsGAuItyONPlgifoCzy65n0+H",
                      "fV8b88j1frP3qcKuMZFjz8MOTFweU9+pU8ot09y46Y9vfHLC6Eoxu1mrWz4aWPT7",
                      "YOpp/1CkJ3iLwNFAs2luZJp8jkL9yH70eZ0CffluEf6eQw6M09z/eUrONTJmGLfi",
                      "eVccfimWFQvNm958ZQlnOylkZpVpOtyHvQcKX126SqtVBCkI8Z5Fz3iRB+GGx2cB",
                      "+q0wKNX6cczgvoP4GFthiL0rxSU4JbjQUm9/rGFBBB4mrBcks2Nd0C+v9p0R35Sy",
                      "q62Ggqz65oPZ"
                    ]
                  ]
                }
              }
            ]
          },
          {
            "PolicyName": "MyBackendServerAuthenticationPolicy",
            "PolicyType": "BackendServerAuthenticationPolicyType",
            "Attributes": [
              {
                "Name": "PublicKeyPolicyName",
                "Value": "MyPublicKeyPolicy"
              }
            ],
            "InstancePorts": [ "443" ]
          }
        ]
      }
    },

    "EcsIamInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [ "ec2.amazonaws.com" ]
              },
              "Action": [ "sts:AssumeRole" ]
            }
          ] },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "ecsInstanceRole",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ecs:CreateCluster",
                    "ecs:RegisterContainerInstance",
                    "ecs:DeregisterContainerInstance",
                    "ecs:DiscoverPollEndpoint",
                    "ecs:Submit*",
                    "ecs:Poll"
                  ],
                  "Resource": [ "*" ]
                }
              ]
            }
          }, {
            "PolicyName": "esInstanceRole",
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ec2:DescribeInstances",
                    "ec2:DescribeAvailabilityZones",
                    "ec2:DescribeRegions",
                    "ec2:DescribeSecurityGroups",
                    "ec2:DescribeTags"
                  ],
                  "Effect": "Allow",
                  "Resource": [ "*" ]
                }
              ],
              "Version": "2012-10-17"
            }
          }, {
            "PolicyName": "S3Snapshots",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:Put*",
                    "s3:Get*",
                    "s3:List*",
                    "s3:AbortMultipartUpload",
                    "s3:DeleteObject"
                  ],
                  "Resource": { "Fn::Join": ["", [ "arn:aws:s3:::", { "Ref": "S3RepositoryBucket" }, "/*"]]}
                }, {
                  "Effect": "Allow",
                  "Action": [
                    "s3:Put*",
                    "s3:Get*",
                    "s3:List*",
                    "s3:AbortMultipartUpload",
                    "s3:DeleteObject"
                  ],
                  "Resource": { "Fn::Join": ["", [ "arn:aws:s3:::", { "Ref": "S3RepositoryBucket" }]]}
                }
              ]
            }
          }
        ]
      }
    },

    "EcsInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [ { "Ref": "EcsIamInstanceRole" } ]
      }
    },

    "LaunchConfiguration": {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "AMI", { "Ref": "AWS::Region"}, "Value" ]},
        "InstanceType" : { "Ref" : "EcsInstanceType" },
        "InstanceMonitoring": false,
        "AssociatePublicIpAddress" : "false",
        "PlacementTenancy": { "Ref": "Tenancy" },
        "IamInstanceProfile": { "Ref": "EcsInstanceProfile" },
        "SecurityGroups" : [ { "Ref" : "EcsSecurityGroup" }, { "Ref": "ElasticSearchSecurityGroup" } ],
        "KeyName": { "Ref": "EC2KeyName" },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvdh",
            "Ebs": {
              "DeleteOnTermination": "true",
              "Encrypted": "true",
              "VolumeSize": { "Ref": "VolumeSize" },
              "VolumeType": "gp2"
            }
          }
        ],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
            "#!/bin/bash\n",
            "echo ECS_CLUSTER=", { "Ref": "EcsCluster" }, " >> /etc/ecs/ecs.config\n",

            "mkfs -t ext4 /dev/xvdh\n",
            "mkdir -p /esdata\n",
            "mount /dev/xvdh /esdata\n",
            "echo \"/dev/xvdh  /esdata  ext4  defaults,nofail  0  2\\n\" >> /etc/fstab\n",
            "chown -R 1000:1000 /esdata\n",

            "echo discovery.ec2.endpoint: \"", { "Fn::FindInMap" : [ "Ec2Endpoint", { "Ref": "AWS::Region"}, "Value" ]}, "\" >> /etc/elasticsearch/elasticsearch.yml\n",
            "echo discovery.ec2.groups: \"", { "Ref": "ElasticSearchSecurityGroup" }, "\" >> /etc/elasticsearch/elasticsearch.yml\n",
            "ip=$(/sbin/ifconfig eth0|grep inet|head -1|sed 's/\\:/ /'|awk '{print $3}')\n",
            "echo network.publish_host: $ip >> /etc/elasticsearch/elasticsearch.yml\n",
            "service docker stop || true\n",
            "service docker start\n",
            "start ecs"
          ] ] }
        }
      }
    },

    "SearchAsg" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "VPCZoneIdentifier" : [ { "Ref" : "PrivateSubnet1" }, { "Ref" : "PrivateSubnet2" }, { "Ref" : "PrivateSubnet3" } ],
        "LaunchConfigurationName" : { "Ref" : "LaunchConfiguration" },
        "MinSize" : { "Ref": "MinClusterSize" },
        "MaxSize" : { "Ref": "MaxClusterSize" },
        "DesiredCapacity" : { "Ref": "DesiredClusterSize" },
        "Cooldown": "60",
        "LoadBalancerNames": [ { "Ref": "PrivateElb" } ],
        "TerminationPolicies": [ "OldestInstance", "Default" ]
      }
    },

    "PrivateDNS": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "AliasTarget": {
          "DNSName": { "Fn::GetAtt": [ "PrivateElb", "DNSName" ] },
          "EvaluateTargetHealth": false,
          "HostedZoneId": { "Fn::GetAtt": ["PrivateElb", "CanonicalHostedZoneNameID"] }
        },
        "HostedZoneId": { "Ref": "PrivateHostedZone" },
        "Name": { "Ref": "PrivateFQDomain" },
        "Type": "A"
      }
    }
  }
}
